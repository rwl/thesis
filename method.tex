\chapter{Modelling Power Trade}
\label{ch:method}
The present chapter defines the models used to simulate electric power trade.
An electricity market model is defined using an optimal power flow
formulation, unit decommitment algorithm and an auction interface derived from
\cite{zimmerman:mp_pes}.  Market participants are modelled as agents, with
associated reinforcement learning methods, whose interactions with the
auction interface are coordinated using a multi-agent system.

% Societies reliance on secure energy supplies and the high volumes of
% electricity typically consumed render it impractical to experiment with
% radically new approaches to energy trade on real systems.  This section
% explains the approach taken modelling real systems in software such that they
% may be simulated computationally.  The method by which the physical power
% systems, that deliver electricity to consumers, were modeled is given, as well
% as for the mechanisms that facilitate trade and participants that utilise
% these mechanisms.
%
% \subsection{Energy market model}
% Mechanisms for facilitating competitive trade between electricity producers and
% consumers differ greatly in the specifics of their implementations in coutries
% throughout the world.  However, fundamentally they either provide a
% centralised pool through which all electricity is bought and sold or they
% permit producers and suppliers to trade directly.
%
% The UK transmission network is frequently congested[].  The thermal limits of
% transmission lines between particular areas are often reached.  The balancing
% mechanism is the financial instrument used by the system operator to resolve
% constraint issues and energy imbalances.  Should the market not be suitably
% effective in this function the system operator may choose to contract outwith
% the balancing mechanism.  By way of incentive to match demand and avoid
% congestion, imbalance charges are imposed on responsible participants.  There
% is some evidence to suggest that centralised resolution by a system operator
% and socialisation of the incurred costs leads to inefficient despatch of
% generators[Neuhoff].
%
% There are a number of alternative approaches to congestion
% resolution.
% %\cite{neuhoff:power}
%
% \subsection{Transmission capacity rights}
% One approach is to issue contracts for transmission capacity rights or
% equivalent financial rights.  The maximum available transmission capacity
% being auctioned for certain periods of time and firm contracts made entitling
% owners to full compensation upon curtailment or
% withdrawl.
% %\cite{efet:principles}.
%
% The states of Pensylvania, New Jersey and Maryland (PJM) operate a
% non-compulsory power pool with nodal market-clearing prices based on
% competitive bids.  This is complemented by daily and monthly capacity markets
% plus the monthly auction of Financial Transmission Rights to provide a hedging
% mechanism against future congestion charges.
%
% \subsection{Transmission charging}
% Impose delivery charges which increase as network constraints are approached.
%
%
% \subsection{Extended bids/offers}
% Request extended bids and offers which include costs associated with the
% adjustment of participant's desired position.
%
% \subsection{Software agents}
% Participants are modeled in software also.  The nature of a highly distributed
% power system dictates that a very large number of entities may be interacting
% in the marketplace.  Economic studies regularly integrate participant logic
% into the same optimisation problem as the market.  However, this does not
% scale to large numbers of individual participants.  Separating participant
% logic into individual software agents allows their action selection procedures
% to be processed in simultaneously.  The definition of an agent in this context
% emerges from the machine learning technique employed to implement the
% competitive decision making process.

\section{Electricity Market Model}
Computation of the generator dispatch points is executed using parts of the
of the optimal power flow formulation from \textsc{Matpower}.
This section describes parts of the optimal power flow formulation,
unit-decommitment algorithm and auction interface from \textsc{Matpower} that
were used to represent a centralised electricity market.  Notable components
of the full optimal power flow forumlation that have been ignored are
generator P-Q capability curves and dispatchable loads. The power flow
equations associated with a network of these components are subsequently
defined. The constrained cost variable approach to modelling generator cost
functions from \cite{zimmerman:ccv} is introduced, from which the optimal
power flow formulation follows.

% The experiments described in Section \ref{ch:method} require an optimal power
% flow problem to be solved at each step.  To accelerate the simulation process
% for certain experiments the option to use a linearised DC formulation is used,
% the formulation of which is provided also.  The tradeoffs between using DC
% models over AC have been examined in \cite{overbye:acdc} and found reasonable
% for locational marginal price calculations.

Since the optimal power flow formulations do not facilitate shutting down
expensive generators, the unit-decommitment algorithm from MATPOWER is defined.
Finally, to provide an interface to agent participants that resembles that of
real electricity market, MATPOWER's auction wrapper for the optimal power flow
routine is described.

\subsection{Power System Model}
\label{sec:power_system_model}
Power systems are modelled as three-phase AC circuits operating in the
steady-state, under balanced conditions that can be represented by an
equivalent single phase nodal graph of busbars connected by branches
\cite{grainger:psa}.

\subsubsection{Branches}
Following \cite[p.11]{pserc:mp_manual}, each branch is modelled as a medium
length transmission line in series with a regulating transformer at the ``from'' end.  A nominal-$\pi$ model with total
series admittance $y_s = 1/(r_s+jx_s)$ and total shunt capacitance $b_c$
represents the transmission line.  The transformer is assumed to be ideal,
phase-shifting and tap-changing, with the ratio between primary winding
voltage $v_{f}$ and secondary winding voltage $N = \tau e^{j\theta_{ph}}$
where $\tau$ is the tap ratio and $\theta_{ph}$ is the phase shift angle.
Figure X diagrams the branch model.  From Kirchhoff's Current Law the current
in the series impedance is
\begin{equation}
\label{eq:iseries}
i_s = \frac{b_c}{2}v_t - i_t
\end{equation}
and from Kirchhoff's Voltage Law the voltage across the secondary winding of
the transformer is
\begin{equation}
\frac{v_{f}}{N} = v_t + \frac{i_s}{y_s}
\end{equation}
Substituting $i_s$ from equation (\ref{eq:iseries}), gives
\begin{equation}
\label{eq:vfrom}
\frac{v_{f}}{N} = v_t - \frac{i_t}{y_s} + v_t\frac{b_c}{2y_s}
\end{equation}
and rearranging in terms if $i_t$, gives
\begin{equation}
\label{eq:ito}
i_t = v_s \left( \frac{-y_s}{\tau e^{\theta_{ph}}} \right) +
v_r \left( y_s + \frac{b_c}{2} \right)
\end{equation}
The current through the secondary winding of the transformer is
\begin{equation}
N^*i_f = i_s + \frac{b_c}{2}\frac{v_{f}}{N}
\end{equation}
Substituting $i_s$ from equation(\ref{eq:iseries}) again, gives
\begin{equation}
N^*i_f = \frac{b_c}{2}v_t - i_t + \frac{b_c}{2}\frac{v_{f}}{N}
\end{equation}
and substituting $\frac{v_{f}}{N}$ from equation (\ref{eq:vfrom}) and
rearranging, gives
\begin{equation}
\label{eq:ifrom}
i_s = v_s \left( \frac{1}{\tau^2} \left(y_s + \frac{b_c}{2}\right) \right) +
v_r \left(\frac{y_s}{\tau e^{-j\theta}}\right)
\end{equation}
Equations (\ref{eq:ito}) and (\ref{eq:ifrom}) are used in section
\ref{sec:acpf} below to define the system admittance matrices that describe
the electrical network.

\subsubsection{Generators}
\label{sec:generators}
Each generator $k$ is modelled as an apparent power injection $s^k_g = p^k_g +
jq^k_g$ at a bus $i$, where $p^k_g$ is the active power injection,
$q^k_g$ is the reactive power injection and each are expressed in per-unit to
the system base MVA.  Upper and lower limits on $p^k_g$ are specified by
$p^k_{max}$ and $p^k_{min}$, respectively, where $p^k_{max} > p^k_{min} \geq
0$.  Similarly, upper and lower limits on $q^k_g$ are specified by $q_{max}^k$
and $q_{min}^k$, respectively, where $q^k_{max} > q^k_{min}$.

\subsubsection{Buses and Loads}
At each bus $i$, constant active power demand is specified by $p^i_d$ and
reactive power demand by $q^i_d$.  Upper and lower limits on the voltage
magnitude at the bus are defined by $v_m^{i,max}$ and $v_m^{i,min}$,
respectively.  One generator bus $i \in \mathcal{I}_{ref}$ in the circuit is
designated the \textit{reference} bus and has voltage angle $\theta^{ref}_k$.
Dispatchable loads are modelled as generators with negative $p^i_g$ and
$p^i_{min} < p^i_{max} = 0$. %TODO: Constant power factor.

\subsection{AC Power Flow Equations}
\label{sec:acpf}
Following \cite[p.13]{pserc:mp_manual}, for a network of $n_b$ buses, $n_l$
branches and $n_g$ generators, let $Cg$ be the $n_b \times n_g$ bus-generator connection matrix such that the $(i,j)^{th}$
element of $C_{g}$ is $1$ if generator $j$ is connected to bus $i$.  The
$n_b \times 1$ vector of complex power injections from generators at all buses
is
\begin{equation}
S_{g,bus} = C_g \cdot S_g
\end{equation}
where $S_g = P_g + jQ_g$ is the $n_g \times 1$ vector with the $i^{th}$ element
is equal to $s^i_g$.

Combining equations (\ref{eq:ito}) and (\ref{eq:ifrom}), the \textit{from}
and \textit{to} end complex current injections for branch $l$ are
\begin{equation}
\label{eq:ybranch}
\begin{bmatrix}
i_f^l\\
i_t^l
\end{bmatrix}
=
\begin{bmatrix}
y_{ff}^l& y_{ft}^l\\
y_{tf}^l& y_{tt}^l
\end{bmatrix}
\begin{bmatrix}
v_f^l\\
v_t^l
\end{bmatrix}
\end{equation}
where
\begin{eqnarray}
\label{eq:yff}
y_{ff}^l& =& \frac{1}{\tau^2} \left(y_s + \frac{b_c}{2}\right)\\
\label{eq:yft}
y_{ft}^l& =& \frac{y_s}{\tau e^{-j\theta_{ph}}}\\
\label{eq:ytf}
y_{tf}^l& =& \frac{-y_s}{\tau e^{j\theta_{ph}}}\\
\label{eq:ytt}
y_{tt}^l& =& y_s + \frac{b_c}{2}
\end{eqnarray}
Let $Y_{ff}$, $Y_{ft}$, $Y_{tf}$ and $Y_{tt}$ be $n_l \times 1$ vectors where
the $l^{th}$ element of each corresponds to $y_{ff}^l$, $y_{ft}^l$,
$y_{tf}^l$ and $y_{tt}^l$, respectively.  Furthermore, let $C_f$ and $C_t$ be the
$n_l \times n_b$ branch-bus connection matrices, where $C_{f_{i,j}} = 1$ and
$C_{t_{i,k}} = 1$ if branch $i$ connects from bus $j$ to bus $k$.  The $n_l
\times n_b$ branch admittance matrices are
\begin{eqnarray}
Y_f& =& \diag(Y_{ff})C_f + \diag(Y_{ft})C_t\\
Y_t& =& \diag(Y_{tf})C_f + \diag(Y_{tt})C_t
\end{eqnarray}
and relate the complex bus voltages $V$ to the branch ``from'' and
``to'' end current vectors
\begin{eqnarray}
I_{f}& =& Y_{f}V\\
I_{t}& =& Y_{t}V
\end{eqnarray}
The $n_b \times n_b$ bus admittance matrix
\begin{eqnarray}
Y_{bus}& =& C_f^\mathsf{T} Y_f + C_t^\mathsf{T} Y_t
\end{eqnarray}
relates the complex bus voltages to the nodal current injections
\begin{eqnarray}
I_{bus}& =& Y_{bus}V
\end{eqnarray}
The complex bus power injections are expressed as a non-linear function of $V$
\begin{eqnarray}
S_{bus}(V)& =& \diag(V)I_{bus}^* \nonumber \\
\label{eq:sbus}
&= & \diag(V)Y_{bus}^*V^*
\end{eqnarray}
As are the complex power injections at the ``from'' and ``to'' ends of all
branches
\begin{eqnarray}
S_{f}(V)& =& \diag(C_fV)I_f^* \nonumber \\
\label{eq:sf_loss}
& =& \diag(C_fV)Y_f^*V^*\\
S_{t}(V)& =& \diag(C_tV)I_t^* \nonumber \\
\label{eq:st_loss}
& =& \diag(C_tV)Y_t^*V^*
\end{eqnarray}
The net complex power injection (generation - load) at each bus must equal the
sum of complex power flows on each branch connected to the bus.  Hence the AC
power balance equations are
\begin{equation}
\label{eq:mismatch}
S_{bus}(V) + S_d - S_g = 0
\end{equation}

\subsection{DC Power Flow Equations}
Following \cite[p.14]{pserc:mp_manual}, the same power system model is used in
the formulation of the linearised DC power flow equations, but the following additional assumptions are made:
\begin{itemize}
  \item The resistance $r_s$ and shunt capacitance $b_c$ of all branches can be
  considered negligible.
  \begin{equation}
  \label{eq:lossless}
  y_s \approx \frac{1}{jx_s}, \quad b_c \approx 0
  \end{equation}
  \item Bus voltage magnitudes $v_{m,i}$ are all approximately 1 per-unit.
  \begin{equation}
  \label{eq:oneperunit}
  v_i \approx 1e^{j\theta_i}
  \end{equation}
  \item The voltage angle difference between bus $i$ and bus $j$ is small enough
  that
  \begin{equation}
  \label{eq:busangdiff}
  \sin\theta_{ij} \approx \theta_{ij}
  \end{equation}
\end{itemize}
Applying the assumption that branches are lossless from equation
(\ref{eq:lossless}), the quadrants of the branch admittance matrix in equations
(\ref{eq:yff}), (\ref{eq:yft}), (\ref{eq:ytf}) and (\ref{eq:ytt}), approximate
to
\begin{eqnarray}
y_{ff}^l& =& \frac{1}{jx_s \tau^2}\\
y_{ft}^l& =& \frac{-1}{jx_s \tau e^{-j\theta_{ph}}}\\
y_{tf}^l& =& \frac{-1}{jx_s \tau e^{j\theta_{ph}}}\\
y_{tt}^l& =& \frac{1}{jx_s}
\end{eqnarray}
respectively.  Applying the uniform bus voltage magnitude assumption from
equation (\ref{eq:oneperunit}) to equation (\ref{eq:ybranch}), the branch
``from'' end current approximates to
\begin{eqnarray}
i_f& \approx& \frac{e^{j\theta_f}}{jx_s\tau^2} -
\frac{e^{j\theta_t}}{jx_s \tau e^{-j\theta_{ph}}}\\
& =& \frac{1}{jx_s\tau} ( \frac{1}{\tau}e^{j\theta_f} -
e^{j(\theta_t + \theta_{ph})} )
\end{eqnarray}
% ToDo: Branch to end current derivation.
and the branch ``from'' end complex power flow $s_f = v_f \cdot i_f^*$
approximates to
\begin{eqnarray}
s_f& \approx& e^{j\theta_f} \cdot \frac{j}{x_s\tau}
(\frac{1}{\tau}e^{-j\theta_f} - e^{j(\theta_t + \theta_{ph})})\\
& =& \frac{1}{x_s\tau} \left[ \sin(\theta_f-\theta_t-\theta_{ph}) +
j\left( \frac{1}{\tau} - \cos(\theta_f-\theta_t-\theta_{ph}) \right) \right]
\end{eqnarray}
Applying the voltage angle difference assumption from equation
(\ref{eq:busangdiff}) yields the approximation
\begin{equation}
p_f \approx \frac{1}{x_s\tau}(\theta_f-\theta_t-\theta_{ph})
\end{equation}
Let $B_{ff}$ and $P_{f,ph}$ be the $n_l \times 1$ vectors where
$B_{ff_i} = 1 / (x_s^i\tau^i)$ and $P_{f,ph_i} =
-\theta_{ph}^i / (x_s^i\tau^i)$.  Then if the system $B$ matrices are
\begin{eqnarray}
B_f& =& \diag(B_{ff})(C_f-C_t)\\
B_{bus}& = &(C_f-C_t)^\mathsf{T}B_f
\end{eqnarray}
then the real power bus injections are
\begin{equation}
\label{eq:bbus}
P_{bus}(\Theta) = B_{bus}\Theta + P_{bus,ph}
\end{equation}
where $\Theta$ is the $n_b \times 1$ vector of bus voltage angles and
\begin{equation}
P_{bus,ph} = (C_f-C_t)^\mathsf{T} + P_{f,ph}
\end{equation}
The active power flows at the branch ``from'' ends are
\begin{equation}
\label{eq:pf_loss}
P_f(\Theta) = B_f\Theta + P_{f,ph}
\end{equation}
and $P_t = -P_f$ since all branches are assumed lossless.

\subsection{AC OPF Formulation}
Following \cite[p.26]{pserc:mp_manual}, generator active and, optionally,
reactive power output costs are defined by a convex $n$-segment piecewise
linear cost function
\begin{equation}
c^{(i)}(x) = m_ip + c_i
\end{equation}
for $p_i \leq p \leq p_{i+1}$ with $i = 1,2,\dotsc n$ where $m_{i+1} \geq m_i$
and $p_{i+1} > p_i$ as diagramed in Figure X.  Since these costs are
non-differentiable the constrained cost variable approach from
\cite{zimmerman:ccv} is used to make the optimisation problem smooth.  For
each generator $i$ a helper cost variable $y_i$ added to the objective
function.  The inequality constraints
\begin{equation}
y_i \geq m_{i,j}(p-p_j) + c_j, \quad j = 1\dotsc n
\end{equation}
require that $y_i$ lies on the epigraph\footnote{Informally, the epigraph of a
function is a set of points lying on or above its graph.} of $c^{(i)}(x)$. The objective of
the optimal power flow problem is to minimise the sum of the cost variables
for all generators.
\begin{equation}
\min_{\theta, V_m, P_g, Q_g, y} \sum_{i=1}^{n_g}y_i
\end{equation}
Equation (\ref{eq:mismatch}) forms an equality constraint which enforce the
balance between the net complex power injection and injections into the
network.  Branch complex power flow limits $S_{max}$ are enforced by the
inequality constraints
\begin{eqnarray}
\abs{S_f(V)} - S_{max}& \leq &0\\
\abs{S_f(V)} - S_{max}& \leq &0
\end{eqnarray}
and the reference bus voltage angle $\theta_i$ is fixed with the equality
constraint
\begin{equation}
\label{eq:refbusang}
\theta_i^{ref} \leq \theta_i \leq \theta_i^{ref}, \quad i \in \mathcal{I}_{ref}
\end{equation}
Upper and lower limits on the optimisation variables $V_m$, $P_g$ and $Q_g$ are
enforced by the inequality constraints
\begin{eqnarray}
v_m^{i,min} \leq v_m^i \leq v_m^{i,max},& \quad i= 1 \dotsc n_b&\\
\label{eq:pglim}
p_g^{i,min} \leq p_g^i \leq p_q^{i,max},& \quad i= 1 \dotsc n_g&\\
q_g^{i,min} \leq q_g^i \leq q_q^{i,max},& \quad i= 1 \dotsc n_g&
\end{eqnarray}

\subsection{DC OPF Formulation}
Piecewise linear cost functions are also used to define generator active power
costs in the DC optimal power flow formulation.  Since the power flow equations
are linearised, following the assumptions in equations (\ref{eq:lossless}),
(\ref{eq:oneperunit}) and (\ref{eq:busangdiff}), the optimal power flow
problem simplifies to a linear program.  The voltage magnitude variables $V_m$
and generator reactive power set-point variable $Q_g$ are eliminated following
the assumption in equation (\ref{eq:busangdiff}) since branch reactive power
flows depend on bus voltage angle differences.  The objective function reduces to
\begin{equation}
\min_{\theta, P_g, y} \sum_{i=1}^{n_g}y_i
\end{equation}
Combining the nodal real power injections, expressed as a function of $\Theta$,
from equation (\ref{eq:bbus}), with active power generation $P_g$ and active
demand $P_d$, the power balance constraint is
\begin{equation}
B_{bus}\Theta + P_{bus,ph} + P_d - C_gP_g = 0
\end{equation}
Limits on branch active power flows $B_f\Theta$ and $B_t\Theta$ are enforced by
the inequality constraints
\begin{eqnarray}
B_f\Theta + P_{f,ph} - F_{max}& \leq& 0\\
-B_f\Theta + P_{f,ph} - F_{max}& \leq& 0
\end{eqnarray}
The reference bus voltage angle equality constraint from
equation (\ref{eq:refbusang}) and the $p_g$ limit constraint from
(\ref{eq:pglim}) are also applied.

\subsection{Optimal Power Flow Solution}
\label{sec:opfsol}
% Generator dispatch points are used with the associated cost functions to
% compute the objective function value -- the total system cost.  The power
% balance Lagrangian multipliers are the shadow prices or system nodal prices and
% equal the cost to the system of supplying one more unit of load at that bus.

\subsection{Unit De-commitment}
The optimal power flow formulation defined in Section \ref{sec:opf} above
requires generators are dispatched within their upper and lower power limits.
Expensive generators can not be completely shutdown, even if doing so would
result in a lower total system cost.  Algorithm \ref{alg:ud} defines the unit
de-commitment algorithm from \cite[p.20]{pserc:mp_manual} which allows a least
cost commitment and dispatch to be determined using the optimal power flow
formulation. The algorithm finds the least cost dispatch by solving repeated
optimal power flow problems with different combinations of generating units
that are at their minimum active power limit deactivated.  The lowest cost
solution is returned when no further improvement can be made and no candidate
generators remain.
\begin{algorithm}[H]
\caption{Unit de-commitment}
\label{alg:ud}
\begin{algorithmic}[1]
\STATE $\text{initialise}~N \leftarrow 0$
\STATE $\text{solve initial OPF}$
\STATE $L_{tot} \leftarrow \text{total load capacity}$
\WHILE{$\text{total min gen.\ capacity} > L_{tot}$}
	\STATE $N \leftarrow N + 1$
\ENDWHILE

\REPEAT
	\FOR{c in candidates}
		\STATE $\text{solve OPF}$
	\ENDFOR
\UNTIL{$\text{done} = \text{True}$}
\end{algorithmic}
\end{algorithm}

\subsection{Auction Interface}
Solving the optimisation problem defined in section \ref{sec:opf} is
intended to represent the function of a pool market operator.  To present
agents participating in this market with an interface more representative of a
real pool market, an auction clearing mechanism is implemented
\cite[p.31]{pserc:mp_manual}.  The interface formulates optimal power flow
problems from lists of offers to sell and bids to buy blocks of power.

An offer/bid specifies a quantity of power in MW and a price for that power in
\$/MWh, to be traded over a particular period of time.  The market accepts sets
of offers and bids and uses the solution of the unit de-commitment algorithm to
clear the offers and bids as appropriate.  The cleared offers/bids are then be
used to compute values of revenue from which earnings/losses may be determined.

The interface allows maximum offer price limits and minimum bids price limits
to be set.  The clearing process the market begins by withholding offers/bids
outwith these limits, along with those specifying non-positive quantities.
Valid offers/bids for each generator are then sorted into
non-decreasing/non-increasing order and used to form new piecewise-linear cost
functions and adjust the generator's active power limits.
% TODO: Provide an example.

The dispatch points and nodal prices from solving the unit de-commitment
optimal power flow with the newly configured generators as input are used in
to determine the proportion of each offer/bid block that should be
cleared and the associated price for each.  Pricing may be uniform or
discriminatory (pay-as-bid).

% Different pricing options arise from the fact that a gap in which any price is
% acceptable to all participants may exist between the last accepted offer price
% and the last accepted bid price (See Figure X).  This allows, for example,
% the prevention of bids setting the price, even when they are marginal, by
% selecting the \textit{last accepted offer} auction type.

% \begin{figure}
% \label{fig:aution_types}
% \centering
% \begin{tikzpicture}[scale=0.75]
% %    \draw[step=1.0cm,color=gray] (0,0) grid (8,5);
%     \coordinate (y) at (0,5);
%     \coordinate (x) at (8,0);
%     \draw[axis] (y) -- node[left] {Price \$/MWh} (0,0) -- node[below] {Quantity (MW)} (x);
%     \coordinate (offprca) at ($0.8*(y)$);
%     \coordinate (offprcb) at ($0.533*(y)$);
%     \coordinate (offqtya) at ($.6*(x)$);
%     \coordinate (offqtyb) at ($.9*(x)$);
%     \draw[] let \p1=(offprca), \p2=(offqtya) in
%     (\p1) node[left] {$\alpha$} -- (\p2);
% \end{tikzpicture}
% \caption{Acceptable price range}
% \end{figure}

\newpage
\section{Multi-Agent System}
\label{sec:mas}
This section describes the implementation of agents and the coordination of
their interactions in multi-agent systems.  A generic market environment, with
which agents interact regardless of the learning method employed, is defined
along with tasks that associate a purpose with an environment.  The design of
connectionist systems and tables, used to represent agent policies, are given
and the process by which they are modified by the agent's learning algorithm is
explained.  Finally, the collection of agents and tasks into a multi-agent
system and the sequence of interactions is illustrated.

\subsection{Agent, Task \& Environment}

\subsubsection{Environment}
Each generator/dispatchable load in the power system model (See Section
\ref{sec:generators}, above) is associated with an agent\footnote{Management of
a portfolio of generators is also supported by the architecture used, but this
feature has not been exploited.} via the agent's environment.  Each environment
maintains an association with a singular market instance for submission of
offers/bids.  Two main operations are supported by an agent's environment.

For a power system with $n_b$ buses, $n_l$ and $n_g$ generators, the
\texttt{getSensors} method returns a $n_s \times 1$ vector of sensor values
$s^i_e$ for generator $i$ where $n_s = 2n_b + 2n_l + 3n_g$.  $s^i_g$ represents
the visible state of the environment for the agent associated with generator
$i$.  $s^i_e$ is composed of sensor values for all buses, branches and
generators.
\begin{equation}
s^i_{e,l} =
\begin{bmatrix}
P_f\\
Q_f\\
P_t\\
Q_t\\
\mu_{S_f}\\
\mu_{S_t}
\end{bmatrix}, \quad
s^i_{e,b} =
\begin{bmatrix}
V_m\\
V_a\\
\lambda_P\\
\lambda_Q\\
\mu_{v_{min}}\\
\mu_{v_{max}}
\end{bmatrix}, \quad
s^i_{e,g} =
\begin{bmatrix}
P_g\\
\mu_{p_{min}}\\
\mu_{p_{max}}\\
\mu_{q_{min}}\\
\mu_{q_{max}}
\end{bmatrix}\ \quad
s^i_e =
\begin{bmatrix}
s^i_{e,b}\\
s^i_{e,b}\\
s^i_{e,g}
\end{bmatrix}
\end{equation}
Not all values are used by the agent and the filtration is done according to
the agent's task.

The \texttt{performAction} method takes $n_a \times 1$ vector of action values
$a_e$ if $s_{bid} = 0$, otherwise a $2n_a \times 1$ vector.  If $s_{bid} = 0$,
the $i$-th element of $a_e$ is the offered/bid price in \$/MWh, where
$i = 1,2,\dotsc n_{in}$.  If $s_{bid} = 1$, the $j$-th element of $a_e$ is the
offered/bid price in \$/MWh, where $j = 1,3,5,\dotsc n_{in}-1$ and the $k$-th
element of $a_e$ is the offered/bid quantity in MW where $j = 2,4,6,\dotsc
n_{in}$.  The action vector is separated into offers/bids and submitted to the
market.  If $s_{bid} = 0$, then $qty = p_{max}/n_{in}$.

\subsubsection{Task}
An agent does not interact directly with it's environment, but is associated
with a particular task.  A task associates a purpose with an environment and
defines what constitutes a reward.  Regardless of the learning method employed,
the goal of an agent participant is to make a financial profit and the rewards
are thus defined as the sum of earnings from the previous period $t$ as
calcualted by the market.  Sensor data from the environment is filtered
according to the task being performed.  Agents using the value-function methods
under test have a tabular representation of their policy with one row per
environment state.  Thus, observations consist of a single integer value $s_v$,
where $s_v \leq n_s$ and $s_v \in \mathbb{Z}^+$.  Agents using the
policy-gradient methods under test have policy functions represented by
connectionist systems that use an input vector $w_i$ of arbitrary length where
the $i$-th element $\in \mathbb{R}$.  Before input to the connectionist policy
function approximator, sensor values are scaled to be between $-1$ and $1$.
Outputs from the policy are denormalised using action limits before the
action is performed on the environment.

\subsubsection{Agent}
Agent $i$ is defined as an entity capable of producing an action $a_i$
based on previous observations of its environment $s_i$, where $a_i$ and $s_i$
are vectors of arbitrary length.  As illustrated in Figure X, each agent is
associated with a \textit{module}, a \textit{learner} and a \textit{dataset}.
The module represents the agent's policy for action selection and returns an
action vector $a_m$ when activated with observation $s_t$.  The value-function
methods under test use modules which represent a $N \times M$ table, where $N$
is the total number of states and $M$ is the total number of actions.
\begin{equation}
\begin{bmatrix}
v_{1,1}& v_{1,2}& \dotsb& v_{1,m}\\
v_{2,1}& \ddots& & \vdots\\
\vdots& &\ddots& \vdots\\
v_{n,1}& \dotsb& \dotsb& v_{n,m}
\end{bmatrix}
\end{equation}
Whereas for the policy gradient methods, the module is a connectionist network
of other modules as illustrated in Figure X.  The learner can use any
reinforcement learning algorithm and modifies the values/parameters of the
policy module to increase expected future reward.  The dataset stores
state-action-reward tuples for each interaction between the agent and its
environment.  The stored history is used by value-function learners when
computing updates to the policy values.  Policy gradient learners search
directly in the space of the policy network parameters.

Value-function learners have an association with an explorer module which
returns an explorative action $a_e$ when activated with the current state $s_t$
and action $a_m$ from the policy module.  For example, the $\epsilon$-greedy
explorer has a randomness parameter $\epsilon$ and a decay parameter $d$.  When
the $\epsilon$-greedy explorer is activated, a random number $x_r$ is drawn
where $0 \leq x_r \leq 1$.  If $x_r < \epsilon$ then a random vector of the same
length as $a_e$ is returned, otherwise $a_e = a_m$.

\subsection{Simulation Event Sequence}
In each simulation of a system consisting of one or more task-agent pairs a
sequence of interactions is coordinated, as illustrated in Figure X.

At the beginning of each step/period the market is initialised and all
offers/bids removed.  From each task-agent tuple $(T,A)$ an observation $s_t$
is retrieved from $T$ and integrated into agent $A$.  When an action is
requested from $A$ its module is activated with $s_t$ and the action $a_e$ is
returned.  $a_e$ is performed on the environment of $A$ via its associated task
$T$.  Recall, this process involves the submission of offer/bids to the market.
Once all actions have been performed the offer/bids are cleared using the
auction mechanism.  Each task $T$ is requested to return a reinforcement reward
$r_t$. All cleared offers/bids associated with the generator in the environment
of $T$ are retrieved from the market and $r_t$ is computed from the difference
between revenue and cost values.
\begin{equation}
r_t = \mbox{revenue} - (c_{fixed} + c_{variable})
\end{equation}
The reward $r_t$ is given to agent $A$ and the value is stored under a new
sample is the dataset, along with the last observation $s_t$ and the last action
performed $a_e$.  Each agent is instructed to learn from its actions using
$r_t$, at which point the values/parameters of the module of $A$ are updated
according to the algorithm of the learner.

This constitutes one step of the simulation and the process is repeated until
the specified number of steps are complete.  Unless agents are reset, the
complete history of states, actions and received rewards is stored in the
dataset of each agent.
